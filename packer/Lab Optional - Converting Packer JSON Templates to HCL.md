# Lab: Migrating JSON to HCL2

Duration: 30 minutes

### Packer Template Languages

Packer uses the Hashicorp Configuration Language - HCL - designed to allow concise descriptions of the required steps to get to a build file.  Previous to HCL Packer utilized JSON as the language for it's build templates.  JSON templates are still supported by the Packer core, but new features added to the Packer core may not be implemented for JSON templates. Therefore it is recommended you transition to HCL templates.  

In this lab we will utilize the `packer hcl2_upgrade` command to convert JSON to HCL2 templates.

#### JSON Templates

Below is an example of a basic builder for AWS EBS AMI in the forms of a JSON Template.  It consists of variables, the amazon-ebs builder and a shell provisioner.

```json
{
  "variables": {
    "aws_source_ami": "ami-039a49e70ea773ffc"
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "us-east-1",
      "source_ami": "{{user `aws_source_ami`}}",
      "instance_type": "t1.micro",
      "ssh_username": "ubuntu",
      "ssh_pty": "true",
      "ami_name": "tmp-{{timestamp}}",
      "tags": {
        "Created-by": "Packer",
        "OS_Version": "Ubuntu",
        "Release": "Latest"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "mkdir ~/src",
        "cd ~/src",
        "git clone https://github.com/hashicorp/demo-terraform-101.git",
        "cp -R ~/src/demo-terraform-101/assets /tmp",
        "sudo sh /tmp/assets/setup-web.sh"
      ]
    }
  ]
}

```

##### Upgrading JSON to HCL2
It is common that you will find Packer template files written in JSON as that was the only templating language supported.  Packer now supports HCL2 templates and it is recommended to utilize this language for both readability and support for new features.

If you have an existing JSON formated Packer template, you can utilize the `packer hcl2_upgrade` command to convert JSON to HCL2 templates.


Once the file is ready we will need to dothe following steps...

1. **packer hcl2_upgrade web-vistors.json** 
    * This command will create a new HCL2 version using the same name of the JSON template with a `.pkr.hcl` appended to it.  This allows you to keep the JSON template untouched as you start to migrate to HCL templates.


2. Run a `packer hcl2_upgrade` command with help option to see the paramaters of the command.


```bash
packer hcl2_upgrade -h

Usage: packer hcl2_upgrade [options] TEMPLATE

  Will transform your JSON template into an HCL2 configuration.

Options:

  -output-file=path    Set output file name. By default this will be the
                       TEMPLATE name with ".pkr.hcl" appended to it. To be a
                       valid Packer HCL template, it must have the suffix
                       ".pkr.hcl"
  -with-annotations    Add helper annotation comments to the file to help new
                       HCL2 users understand the template format.
```

3. 

```shell
packer hcl2_upgrade web-vistors.json
```

```shell
ls

web-vistors.json         web-vistors.json.pkr.hcl

```


4. Inspect new HCL template
```bash
cat web-vistors.json.pkr.hcl
```

```hcl

variable "aws_source_ami" {
  type    = string
  default = "ami-039a49e70ea773ffc"
}

locals { timestamp = regex_replace(timestamp(), "[- TZ:]", "") }

source "amazon-ebs" "autogenerated_1" {
  ami_name      = "tmp-${local.timestamp}"
  instance_type = "t1.micro"
  region        = "us-east-1"
  source_ami    = "${var.aws_source_ami}"
  ssh_pty       = "true"
  ssh_username  = "ubuntu"
  tags = {
    Created-by = "Packer"
    OS_Version = "Ubuntu"
    Release    = "Latest"
  }
}

build {
  sources = ["source.amazon-ebs.autogenerated_1"]

  provisioner "shell" {
    inline = ["mkdir ~/src", "cd ~/src", "git clone https://github.com/hashicorp/demo-terraform-101.git", "cp -R ~/src/demo-terraform-101/assets /tmp", "sudo sh /tmp/assets/setup-web.sh"]
  }

}
```

5. Validate and Build the Image using the HCL template

```bash
packer validate web-vistors.json.pkr.hcl

packer build web-vistors.json.pkr.hcl
```

##### Resources
* Packer [HCL](https://www.packer.io/docs/templates/hcl_templates)
* Packer [JSON](https://www.packer.io/docs/templates/legacy_json_templates)
* Packer [hcl2_upgrade](https://www.packer.io/docs/commands/hcl2_upgrade)
